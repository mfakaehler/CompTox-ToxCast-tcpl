---
title: The ToxCast(TM) Analysis Pipeline(tcpl)<br /> An R Package for Processing and Modeling Chemical Screening Data (Version 2.0)<br />
author: "National Center for Computational Toxicology, US EPA"
output:
  prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{The ToxCast(TM) Analysis Pipeline(tcpl)<br /> An R Package for Processing and Modeling Chemical Screening Data (Version 2.0)<br />}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---
<!-- This CSS script ensures autonumbering of equations-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });
</script>


<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>

```{r eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE}

library(htmlTable)
```

# Introduction

This vignette provides an overview of the <font face="CMTT10"> tcpl </font> package. The tables describing the data structure of the ToxCast database, invitrodb,  are included in the Appendices.

##A. Overview

The <font face="CMTT10"> tcpl </font> package was developed to process high-throughput and high-content screening data generated by the U.S. Environmental Protection Agency (EPA)
ToxCast^TM^ program^[<http://www.epa.gov/ncct/toxcast/>]. ToxCast is screening thousands of chemicals with hundreds of assays coming from numerous and diverse biochemical and cell-based technology platforms. The diverse data, received in heterogeneous formats
from numerous vendors, are transformed to a standard computable format and
loaded into the <font face="CMTT10"> tcpl </font> database by vendor-specific R scripts. Once data is loaded into the database, ToxCast utilizes the generalized processing functions provided
in this package to process, normalize, model, qualify, flag, inspect, and visualize
the data. While developed primarily for ToxCast, we have attempted to make
the <font face="CMTT10"> tcpl </font> package generally applicable to the chemical-screening community.

The <font face="CMTT10"> tcpl </font> package includes processing functionality for two screening paradigms: (1) single-concentration screening and (2) multiple-concentration screening. Single-concentration screening consists of testing chemicals at one concentration, often for the purpose of identifying potentially active chemicals to test in the multiple-concentration format. Multiple-concentration screening consists of testing chemicals across a concentration range, such that the modeled activity can give an estimate of potency, efficacy, etc. This version of the package has an added functionality of evaluating the uncertainty in curvefitting (Appendix E). 

Prior to the pipeline processing provided in this package, all the data must go through pre-processing (level 0). Level 0 pre-processing utilizes dataset-specific R scripts to process the heterogeneous data into a uniform format and to load the uniform data into the <font face="CMTT10"> tcpl </font> database. Level 0 pre-processing is outside the scope of this package, but can be done for virtually any high-throughput or high-content chemical screening effort, provided the resulting data includes the minimum required information. 


In addition to storing the data, the <font face="CMTT10"> tcpl </font> database stores every processing/analysis decision at the assay component or assay endpoint level to facilitate transparency and reproducibility. For the illustrative purposes of this vignette, we have included a CSV version of the <font face="CMTT10"> tcpl </font> database containing a small subset of data from the ToxCast program. Using tcplLite, the user can upload a flat file, in ToxCast database format, and process the data using the tcpl analysis protocols. Using tcpl, the user can upload, process and retrieve data by connecting to a MySQL database. The package includes a SQL file to initialize the MySQL database on the user's server of choice. Additionally, the MySQL version of the ToxCast database containing all the publicly available ToxCast data is available for download at: <http://epa.gov/ncct/toxcast/data.html>.

##B. Package Settings

First, it is highly recommended for users to utilize the <font face="CMTT10"> data.table </font> package. The <font face="CMTT10"> tcpl </font> package utilizes the <font face="CMTT10"> data.table </font> package for all data frame-like objects. 
```{r eval=TRUE, message=FALSE}
library(data.table)
library(tcpl)
## Store the path for the tcpl directory for loading data
pkg_dir <- system.file(package = "tcpl")

```
Every time the package is loaded in a new R session, a message similar to the following will print showing the default package settings:

```{r eval = FALSE}
tcpl (v1.3) loaded with the following settings:
  TCPL_DB:    C:/Users/user/R-3.4.4/library/tcpl/csv
  TCPL_USER:  NA
  TCPL_HOST:  NA
  TCPL_DRVR:  tcplLite
Default settings stored in TCPL.conf. See ?tcplConf for more information.
```
The package consists of five settings: (1) <font face="CMTT10"> $TCPL_DB </font> points to the <font face="CMTT10"> tcpl </font> database (either the path to the CSV directory, as in the given example above, or the name of the MySQL database), (2) <font face="CMTT10"> $TCPL_USER </font> stores the username for accessing the database, (3) <font face="CMTT10"> $TCPL_PASS </font> stores the password for accessing the database, (4) <font face="CMTT10"> $TCPL_HOST </font> points to the MySQL server host, and (5) <font face="CMTT10"> $TCPL_DRVR </font> indicates which database driver to use (either "MySQL", "PostgreSQL" or "tcplLite").

Refer to <font face="CMTT10"> ?tcplConf </font> for more information. At any time, users can check the settings using <font face="CMTT10"> tcplConfList() </font>. An example of database settings using tcpl would be as follows:

```{r eval = FALSE}
tcplConf(drvr = "MySQL", 
         user = "username", 
         pass = "password", 
         host = "localhost",
         db   = "invitrodb")

```

In addition, the settings can be adjusted to the tcplLite driver:
```{r eval = FALSE}
tcplConf(drvr = "tcplLite", db = system.file("csv", package = "tcpl"), user = "", pass = "", host = "")
```

The examples illustrated in this vignette use tcplLite for data uploading and processing. Therefore, the user does not need to change the initialzed settings. For data retrieval, we will provide examples for accessing data from the tcpl database using a MySQL connection (tcpl), and csv files (tcplLite).


Note, <font face="CMTT10"> tcplSetOpts </font> will only make changes to the parameters given. The package is always loaded with the settings stored in the TCPL.config file located within the package directory. The user can edit the file, such that the package loads with the desired settings, rather than having to call the <font face="CMTT10"> tcplSetOpts </font> function every time. The TCPL.config file has to be edited whenever the package is updated or re-installed.

##C. Assay Structure
 
 The definition of an "assay" is, for the purposes of this package, broken into: <br />
 
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp; **assay_source** -- the vendor/origination of the data <br /> <br />
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp; **assay** -- the procedure to generate the component data <br />  <br />
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp; **assay_component** -- the raw data readout(s) <br />  <br />
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp; **assay_component_endpoint** -- the normalized component data <br />  

Each assay element is represented by a separate table in the <font face="CMTT10"> tcpl </font> database. In general, we refer to an "assay_component_endpoint" as an "assay endpoint." As we move down the hierarchy, each additional layer has a one-to-many relationship with the previous layer. For example, an assay component can have multiple assay endpoints, but an assay endpoint can derive only from a single assay component.

All processing occurs by assay component or assay endpoint, depending on the processing type (single-concentration or multiple-concentration) and level. No data are stored at the assay or assay source level. The "assay" and "assay_source" tables store annotations to help in the processing and down-stream understanding/analysis of the data. For more information about the assay annotations and the ToxCast assays, please refer to http://www.epa.gov/ncct/toxcast/.

Throughout the package, the levels of assay hierarchy are defined and referenced by their primary keys (IDs) in the <font face="CMTT10"> tcpl </font> database: $\mathit{asid}$ (assay source ID), $\mathit{aid}$ (assay ID), $\mathit{acid}$ (assay component ID), and $\mathit{aeid}$ (assay endpoint ID). In addition, the package abbreviates the fields for the assay hierarchy names. The abbreviations mirror the abbreviations for the IDs with "nm" in place of "id" in the abbreviations, e.g. assay\_component\_name is abbreviated $\mathit{acnm}$.


#Appendix A:  Field Explanation/Database Structure

This appendix contains reference tables that describe the structure and table fields found in the <font face="CMTT10"> tcpl </font> database. The first sections of this appendix describe the data-containing tables, followed by a section describing the additional annotation tables.

In general, the single-concentration data and accompanying methods are found in the "sc#" tables, where the number indicates the processing level. Likewise, the multiple-concentration data and accompanying methods are found in the "mc#" tables. Each processing level that has accompanying methods will also have tables with the "_methods" and "_id" naming scheme. For example, the database contains the following tables: "mc5" storing the data from multiple-concentration level 5 processing, "mc5_methods" storing the available level 5 methods, and "mc5_aeid" storing the method assignments for level 5. Note, the table storing the method assignments for level 2 multiple-concentration processing is called "mc2_acid", because MC2 methods are assigned by assay component ID.

There are two additional tables, "sc2\_agg" and "mc4\_agg," that link the data in tables "sc2" and "mc4" to the data in tables "sc1" and "mc3," respectively. This is necessary because each entry in the database before SC2 and MC4 processing represents a single value; subsequent entries represent summary/modeled values that encompass many values. To know what values were used in calculating the summary/modeled values, the user must use the "\_agg" look-up tables.

Each of the methods tables have fields analogous to $\mathit{mc5\_mthd\_id}$, $\mathit{mc5\_mthd}$, and $\mathit{desc}$. These fields represent the unique key for the method, the abbreviated method name (used to call the method from the corresponding <font face="CMTT10"> mc5\_mthds </font> function), and a brief description of the method, respectively. The "mc6\_methods" table may also include $\mathit{nddr}$ field. More information about $\mathit{nddr}$ is available in the discussion of multiple-concentration level 6 processing.

The method assignment tables will have fields analogous to $\mathit{mc5\_mthd\_id}$ matching the method ID from the methods tables, an assay component or assay endpoint ID, and possibly an $\mathit{exec\_ordr}$ field indicating the order in which to execute the methods.

The method and method assignment tables will not be listed in the tables below to reduce redundancy. 

Many of the tables also include the $\mathit{created\_date}$, $\mathit{modified\_date}$, and $\mathit{modified\_by}$ fields that store helpful information  for tracking changes to the data. These fields will not be discussed further or included in the tables below.

Many of the tables specific to the assay annotation are not utilized by the <font face="CMTT10"> tcpl </font> package. The full complexity of the assay annotation used by the ToxCast program is beyond the scope of this vignette and the  <font face="CMTT10"> tcpl </font> package. More information about the ToxCast assay annotation can be found at: http://epa.gov/ncct/toxcast/data.html.

##A. Single-concentration data-containing tables
<!-- Table 5-->
```{r warning = FALSE, echo = FALSE}
Field <- c("s0id ", "acid", "spid", "cpid", "apid", "rowi", "coli", "wllt", "wllq", "conc", "rval", "srcf")
Description <- c("Level 0 ID",
                 "Assay component ID",
                 "Sample ID",
                 "Chemical plate ID",
                 "Assay plate ID",
                 "Assay plate row index",
                 "Assay plate column index",
                 "Well type&dagger;",
                 "1 if the well quality was good, else 0&ddagger;",
                 "Concentration is micromolar",
                 "Raw assay component value/readout from vendor",
                 "Filename of the source file containing the data"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 5: Fields in sc0 table.",
        tfoot="&dagger;Information about the different well types is available in Appendix B.")

```

<!-- Table 6-->
```{r warning = FALSE, echo = FALSE}
Field <- c("s1id ", "s0id", "acid", "aeid", "logc", "bval", "pval", "resp")
Description <- c("Level 1 ID",
                 "Level 0 ID",
                 "Assay component ID",
                 "Assay component endpoint ID",
                 "Log base 10 concentration",
                 "Baseline value",
                 "Positive control value",
                 "Normalized response value"
              
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 6: Fields in sc1 table."
)

```
<!-- Table 7-->


```{r warning = FALSE, echo = FALSE}
Field <- c("aeid ", "s0id", "s1id", "s2id")
Description <- c("Assay component endpoint ID",
                 "Level 0 ID",
                 "Level 1 ID",
                 "Level 2 ID"
              
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 7: Fields in sc2_agg table."
)

```

<!-- Table 8-->
```{r warning = FALSE, echo = FALSE}
Field <- c("s2id ", "aeid", "spid", "bmad", "max_med", "hitc", "coff", "tmpi")
Description <- c("Level 2 ID",
                 "Assay component endpoint ID",
                 "Sample ID",
                 "Baseline median absolute deviation",
                 "Maximum median response value",
                 "Hit-/activity-call, 1 if active, 0 if inactive",
                 "Efficacy cutoff value",
                 "Ignore, temporary index used for uploading purposes"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 8: Fields in sc2 table."
)

```
##B. Multiple-concentration data-containing tables
<!-- Table 9-->
The "mc0" table, other than containing $\mathit{m0id}$ rather than $\mathit{s0id}$, is identical to the "sc0" described in the section above.
```{r warning = FALSE, echo = FALSE}
Field <- c("m1id", "m0id", "acid", "cndx", "repi")
Description <- c("Level 1 ID",
                 "Level 0 ID",
                 "Assay component ID",
                 "Concentration index",
                 "Replicate index"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 9: Fields in mc1 table."
)

```
<!-- Table 10-->


```{r warning = FALSE, echo = FALSE}
Field <- c("m2id", "m0id", "acid", "m1id", "cval")
Description <- c("Level 2 ID",
                 "Level 0 ID",
                 "Assay component ID",
                 "Level 1 ID",
                 "Corrected value"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 10: Fields in mc2 table."
)

```
<!-- Table 11-->
```{r warning = FALSE, echo = FALSE}
Field <- c("m3id", "aeid", "m0id", "acid", "m1id", "m2id", "bval", "pval", "logc", "resp")
Description <- c("Level 3 ID",
                 "Assay endpoint ID",
                 "Level 0 ID",
                 "Assay component ID",
                 "Level 1 ID",
                 "Level 2 ID",
                 "Baseline value",
                 "Positive control value",
                 "Log base 10 concentration",
                 "Normalized response value"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 11: Fields in mc3 table."
)

```
<!-- Table 12-->
```{r warning = FALSE, echo = FALSE}
Field <- c("aeid", "m0id", "m1id", "m2id", "m3id", "m4id")
Description <- c(
   "Assay endpoint ID","Level 0 ID",
                 "Level 1 ID",
                 "Level 2 ID",
                 "Level 3 ID",
                 "Level 4 ID"
                 
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 12: Fields in mc4_agg table."
)

```
<!-- Table 13-->
```{r warning = FALSE, echo = FALSE}
Field <- c("m4id", "aeid", "spid", "bmad", "resp_max", "resp_min", "max_mean", "max_mean_conc", "max_med", "max_med_conc", "logc_max", "logc_min", "cnst", "hill", "hcov", "gnls", "gcov", "cnst_er", "cnst_aic", "cnst_rmse", "cnst_prob", "hill_tp", "hill_tp_sd", "hill_ga", "hill_ga_sd")

Description <- c("Level 4 ID",
                 "Assay endpoint ID",
                 "Sample ID",
                 "Baseline median absolute deviation",
                 "Maximum response value",
                 "Minimum response value",
                 "Maximum mean response value",
                 "Log concentration at *max_mean*",
                 "Maximum median response value",
                 "Log concentration at *max_med*",
                 "Maximum log concentration tested",
                 "Minimum log concentration tested",
                 "1 if the constant model converged, 0 if it failed to converge, N/A if series had less than four concentrations",
                  "1 if the Hill model converged, 0 if it failed to converge, N/A if series had less than four concentrations or if *max_med* < *3bmad*",
                "1 if the Hill model Hessian matrix could be inverted, else 0",
      "1 if the gain-loss model converged, 0 if it failed to converge, N/A
if series had less than four concentrations or if *max_med* < *3bmad*",
                "1 if the gain-loss model Hessian matrix could be inverted, else 0",
                "Scale term for the constant model",
                "AIC for the constant model",
                "RMSE for the constant model",
                "Probability the constant model is the true model",
                "Top asymptote for the Hill model",
                "Standard deviation for *hill_tp*",
                "AC~50~ for the Hill model",
                 "Standard deviation for *hill_ga* "
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 13: Fields in mc4 table (Part 1)."
)

```
<!-- Table 14-->
```{r warning = FALSE, echo = FALSE}
Field <- c("hill_gw", "hill_gw_sd", "hill_er", "hill_er_sd", "hill_aic", "hill_rmse", "hill_prob", "gnls_tp", "gnls_tp_sd", "gnls_ga", "gnls_ga_sd", "gnls_gw", "gnls_gw_sd", "gnls_la", "gnls_la_sd", "gnls_lw", "gnls_lw_sd", "gnls_er", "gnls_er_sd", "gnls_aic", "gnls_rmse", "gnls_prob", "nconc", "npts", "nrep", "nmed_gtbl", "tmpi")

Description <- c("Hill coefficient",
                 "Standard deviation for *hill_gw*",
                 "Scale term for the Hill model",
                 "Standard deviation for *hill_er*",
                 "AIC for the Hill model",
                 "RMSE for the Hill model",
                 "Probability the Hill model is the true model",
                 "Top asymptote for the gain-loss model",
                 "Standard deviation for *gnls_tp*",
                 "AC~50~ in the gain direction for the gain-loss model",
                 "Standard deviation for *gnls_ga*",
                 "Hill coefficient in the gain direction",
                 "Standard deviation for *gnls_gw* ",
                 "AC~50~ in the loss direction for the gain-loss model",
                 "Standard deviation for *gnls_la*",
                "Hill coefficient in the loss direction",
                "Standard deviation for the *gnls_lw*",
                 "Scale term for the gain-loss model",
                 "Standard deviation for *gnls_er*",
                 "AIC for the gain-loss model",
                 "RMSE for the gain-loss model",
                "Probability the gain-loss model is the true model",
                "Number of concentrations tested ",
                "Number of points in the concentration series",
                "Number of replicates in the concentration series",
                "Number of median values greater than *3bmad*",
                "Ignore, temporary index used for uploading purposes"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 14: Fields in mc4 table (Part 2)."
)

```

```{r warning = FALSE, echo = FALSE}
Field <- c("m5id", "m4id", "aeid", "modl", "hitc", "fitc", "coff", "actp", "modl_er", "modl_tp", "modl_ga", "modl_gw", "modl_la", "modl_lw", "modl_prob", "modl_rmse", "modl_acc", "modl_acb", "modl_ac10")

Description <- c("Level 5 ID",
                 "Level 4 ID",
                 "Assay endpoint ID",
                 "Winning model: \"cnst\", \"hill\", or \"gnls\"",
                 "Hit-/activity-call, 1 if active, 0 if inactive, -1 if cannot determine",
                 "Fit category",
                 "Effcacy cutoff value",

                "Activity probability (1 - *const_prob*)",
                "Scale term for the winning model",
                "Top asymptote for the winning model",
                "Gain AC~50~ for the winning model",
              "Gain Hill coefficient for the winning model",
              "Loss AC~50~ for the winning model",
       "Loss Hill coefficient for the winning model",
       "Probability for the winning model",
       "RMSE for the winning model",
       "Activity concentration at cutoff for the winning model",
       "Activity concentration at baseline for the winning model",
       "AC10 for the winning model"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 15: Fields in mc5 table."
)

```

<!-- Table 16-->


```{r warning = FALSE, echo = FALSE}
Field <- c("m6id", "m5id", "m4id", "aeid", "m6_mthd_id", "flag", "fval", "fval_unit")

Description <- c("Level 6 ID",
                 "Level 5 ID",
                 "Level 4 ID",
                 "Assay endpoint ID",
                 "Level 6 method ID",
                 "Text output for the level 6 method",
                 "Value from the flag method, if applicable",
                 "Units for *fval* , if applicable" )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 16: Fields in mc6 table."
)

```

<!-- Table 17-->


```{r warning = FALSE, echo = FALSE}
Field <- c("m4id", "Aeid", "Aenm", "Asid", "Acid", "Hit_pct", "Total_hitc", "Modl_ga_min", "Modl_ga_max", "Modl_ga_med", "Modl_gw_med", "Modl_ga_delta", "Cnst_pct", "Hill_pct", "Gnls_pct")

Description <- c("Level 4 ID",
                 "Assay endpoint ID",
                 "Assay endpoint name",
                 "Assay source ID",
                 "Assay component ID",
                 "Total percent of hit calls made after 1000 bootstraps",
                 "Total number of hit calls made after 1000 bootstraps",
                 "Low bound of the 95% confidence interval for the AC~50~",
                 "Upper bound of the 95% confidence interval for the AC~50~",
                 "Median AC~50~ after 1000 bootstraps",
                 "Median gain Hill coefficient for 1000 bootstraps",
                 "AC~50~ confidence interval width in log units",
                 "Percent of 1000 bootstraps that the constant model was selected as the winning model", 
                 "Percent of 1000 bootstraps that the Hill model was selected as the winning model",
                 "Percent of 1000 bootstraps that the gain-loss was selected as the winning model")

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 17: Fields in mc7 table."
)

```

##C. Auxiliary annotation tables
As mentioned in the introduction to this appendix, a full description of the assay annotation is beyond the scope of this vignette. The fields pertinent to the <font face="CMTT10"> tcpl </font> package are listed in the tables below.
<!-- Table 18-->
```{r warning = FALSE, echo = FALSE}
Field <- c("assay", "assay_component", "assay_component_endpoint", "assay_component_map", "assay_reagent**", "assay_reference**", "assay_source", "chemical", "chemical_library", "citations**", "gene", "intended target**", "mc5_fit_categories", "organism**", "sample", "technological_target**")

Description <- c("Assay-level annotation",
                 "Assay component-level annotation",
                 "Assay endpoint-level annotation",
                 "Assay component source names and their corresponding assay component ids",
                 "Assay reagent information",
                 "Map of citations to assay",
                 "Assay source-level annotation",
                 "List of chemicals and associated identifiers",
                 "Map of chemicals to different chemical libraries",
                 "List of citations",
                 "Gene** identifers and descriptions",
                 "Intended assay target at the assay endpoint level",
                 "The level 5 fit categories",
                "Organism identifiers and descriptions",
                "Sample ID information and chemical ID mapping",
                "Technological assay target at the assay component level")

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        caption="Table 18: List of annotation tables.",
        tfoot = "** indicates tables not currently used by the *tcpl* package",
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em '
)

```
<!-- Table 19-->
```{r warning = FALSE, echo = FALSE}
Field <- c("aid", "asid", "assay_name", "assay_desc", "timepoint_hr", "assay_footprint")

Description <- c("Assay ID",
                 "Assay source ID",
                 "Assay name (abbreviated \"anm\" within the package)",
                 "Assay description",
                 "Treatment duration in hours",
                 "Microtiter plate size&dagger;")

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        caption="Table 19: Fields in assay.",
        tfoot = "&dagger; discussed further in the \"Register and Upload New Data\" section",
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em '
)

```
<!-- Table 20-->

```{r warning = FALSE, echo = FALSE}
Field <- c("acid", "aid", "assay_component_name", "assay_component_desc")

Description <- c("Assay component ID",
                 "Assay ID",
                 "Assay component name (abbreviated \"acnm\" within the package)",
                 "Assay component description"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 20: Fields in assay_component."
)

```
<!-- Table 21-->

```{r warning = FALSE, echo = FALSE}
Field <- c("asid", "assay_source_name", "assay_source_long_name", "assay_source_description")

Description <- c("Assay source ID",
                 "Assay source name (typically an abbreviation of the
assay_source_long_name, abbreviated \"asnm\" within the package)",
                 "The full assay source name", 
                 "Assay source description"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 21: Fields in assay_source."
)

```
<!-- Table 22-->
```{r warning = FALSE, echo = FALSE}
Field <- c("aeid", "acid", "assay_component_endpoint_name", "assay_component_endpoint_desc", "export_ready", "normalized_data_type", "burst_assay", "fit_all")

Description <- c("Assay component endpoint ID",
                 "Assay component ID",
                 "Assay component endpoint name (abbreviated \"aenm\" within the
package)", 
                 "Assay component endpoint description",
"0 or 1, used to flag data as \"done\"",
                 "The units of the normalized data&dagger;",
                 "0 or 1, 1 indicates the assay results should be used in calculating the burst z-score",
                 "0 or 1, 1 indicates all results should be fit, regardless of whether the *max_med* surpasses *3bmad*"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 22: Fields in assay_component_endpoint.",
        tfoot = "&dagger; discussed further in the \"Register and Upload New Data\" section"
)

```
<!-- Table 23-->

```{r warning = FALSE, echo = FALSE}
Field <- c("acid", "acsn")

Description <- c("Assay component ID",
                 "Assay component source name"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 23: Fields in assay_component_map table."
)

```
<!-- Table 24-->
```{r warning = FALSE, echo = FALSE}
Field <- c("chid", "casn", "chnm")

Description <- c("Chemical ID&dagger;",
                 "CAS Registry Number",
                 "Chemical name"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 24: Fields in chemical table." ,
        tfoot = "&dagger; this is the DSSTox GSID within the ToxCast data, but can be any integer and will be auto-generated (if not explicitly defined) for newly registered
chemicals"
)

```
<!-- Table 25-->
```{r warning = FALSE, echo = FALSE}
Field <- c("chid", "clib")

Description <- c("Chemical ID",
                 "Chemical library"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 25: Fields in chemical_library table." 
     
)

```
<!-- Table 26-->

```{r warning = FALSE, echo = FALSE}
Field <- c("fitc", "parent_fitc", "name", "xloc", "yloc")

Description <- c("Fit category",
                 "Parent fit category",
                 "Fit category name" ,
                 "x-axis location for plotting purposes",
                 "y-axis location for plotting purposes"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 26: Fields in mc5_fit_categories." 
     
)

```
<!-- Table 27-->
```{r warning = FALSE, echo = FALSE}
Field <- c("spid", "chid", "stkc", "stkc_unit", "tested_conc_unit", 
           "spid_legacy")

Description <- c("Sample ID",
                 "Chemical ID",
                 "Stock concentration" ,
                 "Stock concentration unit",
                 "The concentration unit for the concentration values in the data-containing tables",
                 "A place-holder for previous sample ID strings"
                 )

output <- 
  data.frame(Field, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 27: Fields in sample table." 
)

```
The stock concentration fields in the "sample" table allow the user to track the original concentration when the neat sample is solubilized in vehicle before any serial dilutions for testing purposes. 

#Appendix B:  Level 0 Pre-processing

Level 0 pre-processing can be done on virtually any high-throughput/high-content screening application. In the ToxCast program, level 0 processing is done in R by vendor/dataset-specific scripts. The individual R scripts act as the "laboratory notebook" for the data, with all pre-processing decisions clearly commented and explained. 

Level 0 pre-processing has to reformat the raw data into the standard format for the pipeline, and also can make manual changes to the data. All manual changes to the data should be very well documented with justification. Common examples of manual changes include fixing a sample ID typo, or changing well quality value(s) to 0 after finding obvious problems like a plate row/column missing an assay reagent. 

Each row in the level 0 pre-processing data represents one well-assay component combination, containing 11 fields (Table 28). The only field in level 0 pre-processing not stored at level 0 is the assay component source name ($\mathit{acsn}$). The assay component source name should be some concatenation of data from the assay source file that identifies the unique assay components. When the data are loaded into the database, the assay component source name is mapped to assay component ID through the assay\_component\_map table in the <font face="CMTT10"> tcpl </font> database. Assay components can have multiple assay component source names, but each assay component source name can only map to a single assay component. 

<!-- Table 28-->
```{r warning = FALSE, echo = FALSE}
Field <- c("acsn", "spid", "cpid", "apid", "rowi", 
           "coli", "wllt", "wllq", "conc", "rval", "srcf")

Description <- c("Assay component source name",
                 "Sample ID",
                 "Chemical plate ID" ,
                 "Assay plate ID",
                 "Assay plate row index, as an integer",
                 "Assay plate column index, as an integer",
                 "Well type",
                 "1 if the well quality was good, else 0",
                 "Concentration in micromolar",
                 "Raw assay component value/readout from vendor",
                 "Filename of the source file containing the data"
                 )
`N/A` <- c("No", "No", "Yes", "Yes","Yes","Yes", "No", "No", "No&dagger;", "Yes&ddagger;", "No")

output <- 
  data.frame(Field, Description, `N/A`)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        
          caption="Table 28: Required felds in level 0 pre-processing." ,
          tfoot = "The N/A column indicates whether the field can be N/A in the pre-processed data.
 &dagger;Concentration can be N/A for control values only tested at a single
concentration. Concentration cannot be N/A for any test compound (well
type of \"t\") data.
 &ddagger;If the raw value is N/A, well type has to be 0."
)

```

The well type field is used in the processing to differentiate controls from test compounds in numerous applications, including normalization and definition of the assay noise level. Currently, the <font face="CMTT10"> tcpl </font> package includes the eight well types in Table 29. Package users are encouraged to suggest new well types and methods to better accommodate their data. 

<!-- Table 29-->


```{r warning = FALSE, echo = FALSE}
`Well Type` <- c("t", "c", "p", "n", "m", 
           "o", "b", "v")

Description <- c("Test compound",
                 "Gain-of-signal control in multiple concentrations",
                 "Gain-of-signal control in single concentration" ,
                 "Neutral/negative control",
                 "Loss-of-signal control in multiple concentrations",
                 "Loss-of-signal control in single concentration",
                 "Blank well",
                 "Viability control"
                 )


output <- 
  data.frame(`Well Type`, Description)

library(htmlTable)
htmlTable(output,
        align = 'l',
        align.header = 'l',
        rnames = FALSE  ,
        css.cell =  ' padding-bottom: 5px;  vertical-align:top; padding-right: 10px;min-width: 5em ',
        caption="Table 29: Well types" 
)

```


The final step in level 0 pre-processing is loading the data into the <font face="CMTT10"> tcpl </font> database. The  <font face="CMTT10"> tcpl </font> package includes the <font face="CMTT10"> tcplWriteLvl0 </font> function to load data into the database. The <font face="CMTT10"> tcplWriteLvl0</font> function maps the assay component source name to the appropriate assay component ID, checks each field for the correct class, and checks the database for the sample IDs with well type "t." Each test compound sample ID must be included in the <font face="CMTT10"> tcpl</font> database before loading data. The <font face="CMTT10"> tcplWriteLvl0</font> also checks each test compound for concentration values.


#Appendix C:  Cytotoxicity Distribution

Recognizing the susbtantial impact of cytotoxicity in confounding high-throughput and high-content screening results, the <font face="CMTT10"> tcpl</font>  package includes methodology for defining chemical-specific cytotoxicity estimates. Our observations based on ToxCast data suggest a complex, and not-yet fully understood cellular biology that includes non-specific activation of many targets as cells approach death. For example, a chemical may induce activity in an estrogen-related assay, but if that chemical also causes activity in hundreds of other assays at or around the same concentration as cytotoxicity, should the chemical be called an estrogen agonist? The <font face="CMTT10"> tcplCytpPt</font>  function provides an estimate of chemical-specific cytotoxicity points to provide some context to the "burst" phenomenon.

The cytotoxicity point is simply the median AC$_{50}$ for a set of assay endpoints, either given by the user or defined within the <font face="CMTT10"> tcpl</font>  database. By default, the <font face="CMTT10"> tcplCytoPt</font>  function uses the assay endpoints listed in the $\mathit{burst\_assay}$ field of the "assay\_component\_endpoint" table, where 1 indicates including the assay endpoint in the calculation. The "burst" assay endpoints can be indentified by running  <font face="CMTT10"> tcplLoadAeid(fld = "burst\_assay", val = 1) </font>.

In addition to the cytotoxicity point, <font face="CMTT10">tcplCytoPt </font> provides two additional estimates: (1) the MAD of the AC$_{50}$ ($\mathit{modl\_ga}$) values used to calculate the cytotoxicity point, and (2) the global MAD. Note, only active assay endpoints (where the hit call, $\mathit{hitc}$, equals $1$) are included in the calculations. Once the burst distribution (cytotoxicity point and MAD) is defined for each chemical, the global burst MAD is defined as the median of the MAD values. Not every chemcial may be tested in every "burst" assay, so the user can determine the minimum number of tested assays as a condition for the MAD value for a particular chemical to be included in the global MAD calculation. By default, if "aeid" is the vector of assay endpoints used in the calculation, <font face="CMTT10">tcplCytoPt </font> requires the chemical to be tested in at least <font face="CMTT10">floor(0.8 * length(aeid)) </font> assay endpoints to be included in the calculation. The user can specify to include all calculated MAD values (note, there must be at least two active assay endpoints to calculate the MAD) by setting 'min.test' to <font face="CMTT10">FALSE </font>. The 'min.test' parameter also accepts a number, allowing the user to explicitly set the requirement.

The global MAD gives an estimate of overall cytotoxicity window, and allows for a cytotoxicity distrubtion to be determined for chemicals with less than two active "burst" assay endpoints. The cytotoxicity point for chemicals with less than two active "burst" endpoints is set to the value given to the 'default.pt' parameter. By default, the <font face="CMTT10">tcplCytoPt </font> assigns 'default.pt' to 3.^[$10^3 = 1000$, therefore, when using micromolar units, $3$ is equivalent to $1$ millimolar. $1$ millimolar was chosen as an arbitrary high concentration (outside the testing range for ToxCast data), based on the principle that all compounds are toxic if given in high enough concentration.]


# Appendix D: Build Variable Matrices

The  <font face="CMTT10">tcplVarMat </font> function creates chemical-by-assay matrices for the level 4 and level 5 data. When multiple sample-assay series exist for one chemical, a single series is selected by the <font face="CMTT10"> tcplSubsetChid </font> function. See <font face="CMTT10">?tcplSubsetChid </font> for more information. <br/>

 1. "modl\_ga" -- The $\log_{10}\mathit{AC_{50}}$ (in the gain direction) for the winning model. <br/> 
 2. "hitc" -- The hit call for the winning model. <br/>
 3. "m4id" -- The m4id, listing the concentration series selected by  <font face="CMTT10">tcplSubsetChid </font>. <br\>
 4. "zscore" -- The z-score (described below). <br\>
 5.  "tested\_sc" -- $1$ or $0$, $1$ indicating the chemical/assay pair was tested in the single-concentration format. <br\>
 6. "tested\_mc" -- $1$ or $0$, $1$ indicating the chemical/assay pair was tested in the multiple-concentration format. <br\>
 7. "ac50" -- a modified AC$_{50}$ table (in non-log units) where assay/chemical pairs that were not tested, or tested and had a hit call of $0$ or $-1$ have the value $1e6$. <br\>
 8. "neglogac50" -- $-\log_{10}\frac{\mathit{AC_{50}}}{1e6}$ where assay/chemical pairs that were not tested, or tested and had a hit call of $0$ or $-1$ have the value $0$. <br\>


The z-score calculation is based on the output from <font face="CMTT10"> tcplCytoPt </font> (Appendix C), and is calculated for each AC$_{50}$ value as follows: 
$$
\mathit{z-score} = -\frac{\mathit{modl\_ga} - \mathit{cyto\_pt}}{\mathit{global\_mad}}\mathrm{,} 
$$
Note: the burst z-score values are multiplied by -1 to make values that are more potent relative to the burst distribution a higher positive z-score.

In addition, the standard matrices, additional matrices can be defined by the 'add.vars' parameter in the <font face="CMTT10"> tcplCytoPt </font>  function. The 'add.vars' function will take any level 4 or level 5 field and create the respective matrix. 

#Appendix E:  Curve Fitting Uncertainty

The level 7 in the <font face="CMTT10"> tcpl</font> package provides a quantitative metric for assessing the uncertainty in identifying active chemicals in high-throughput chemical screening assays. Consequently, the pipeline will be able to better identify false positive, and false negative hit calls. This level uses the bootstrapping method used in the <font face="CMTT10"> toxboot </font> R package. Briefly, <font face="CMTT10"> toxboot </font> uses a smooth nonparametric bootstrap resampling to add random normally distributed noise to give a resampled set of concentration-response values. The resampled data are fit to the three ToxCast models, and repeated 1000 times. The resulting data are used to generate point estimates, the winning model, and a hit call for each of the 1000 resamples. Various summary statistics,  such as hit percent, median AC$_{50}$, and AC$_{50}$ confidence interval are generated based on the toxboot resampling. For more information on the <font face="CMTT10"> toxboot </font> package, the user can access the documentation available on the CRAN depository.^[https://CRAN.R-project.org/package=toxboot]

The <font face="CMTT10"> tcpl</font> package provides a platform for identifying active chemicals from >1000 chemical-assay endpoint pairs. The curve fits for these pairs are prone to variabilities in the calculated parameters due to biological variance, and model fitting to name a few. The extent of uncertainty in the bioactivity values can propagate errors in estimating toxicological endpoints used for risk assessment. The quantitative strategy used in level 7 to assess the uncertainty in the fitted bioactivity values, such as AC$_{50}$, can increase the predictive power of in vitro toxicity prediction.  The addition of level 7 allows the user to calculate the hit percent, a probabilistic metric for determining the hit call for a chemical-assay endpoint pair ranging from 0 to 1. Instead of the binary hit call, 0 or 1, the hit percent has a higher sensitivity to noise and artefacts in the fitted data. Level 7 data can be retrieved from the MySQL database using the <font face="CMTT10"> tcplLoadData </font> function. The user will need the m4id(s) corresponding to the sample(s) of interest.

